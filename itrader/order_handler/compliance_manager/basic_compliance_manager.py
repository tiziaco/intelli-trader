from ..base import OrderBase
from itrader.events_handler.event import SignalEvent
from itrader.portfolio_handler.portfolio_handler import PortfolioHandler

from itrader.logger import get_itrader_logger

class ComplianceManager():
	"""
	The Compliance class manage the signal event coming from the 
	strategy class.

	It verifies that all the entering rules are compliant with the 
	defined conditions. It checks if a position is already open 
	and if the number of opened positions in a portfolio has reached 
	the defined limit
	"""
	def __init__(self, portfolio_handler: PortfolioHandler):
		self.portfolio_handler = portfolio_handler
		self.logger = get_itrader_logger().bind(component="ComplianceManager")
		self.logger.info('Compliance Manager initialized')

	
	def check_compliance(self, signal: SignalEvent):
		"""
		Check if there's already an opened position in the portfolio
		and if the max. number of positions is reached.

		Parameters
		----------
		signal: `Event object`
			The Signal event generated by a strategy
		"""
		allow_increase = signal.strategy_setting.get('allow_increase')

		if not allow_increase:
			self.check_position_increase(signal)
		if signal.verified:
			self.check_max_open_positions(signal)
		if signal.verified == True:
			self.logger.debug('Order validated')

	def check_max_open_positions(self, signal: SignalEvent):
		portfolio_id = signal.portfolio_id
		ticker = signal.ticker
		portfolio = self.portfolio_handler.get_portfolio(portfolio_id)
		position = portfolio.positions.get(ticker)
		n_open_positions = portfolio.n_open_positions
		max_position = signal.strategy_setting.get('max_positions')

		if (not position and n_open_positions <= max_position) or \
			(position.side == 'LONG' and signal.action == 'SELL') or \
			(position.side == 'SHORT' and signal.action == 'BUY'):
			signal.verified = True
		if signal.verified == False:
			self.logger.warning('Order refused. Max positions reached.')

	def check_position_increase(self, signal: SignalEvent):
		"""
		Check if the signal action is compliant with the existing open position for the given ticker.

		Parameters
		----------
		signal: SignalEvent
			The signal event generated by a strategy
		"""
		portfolio_id = signal.portfolio_id
		ticker = signal.ticker
		portfolio = self.portfolio_handler.get_portfolio(portfolio_id)
		# Check if I have open positions
		if portfolio and not portfolio.positions:
			signal.verified = True
			return
		# Check if i have an open position for the signal's ticker
		position = portfolio.positions.get(ticker)
		if not position:
			signal.verified = True
			return
		# Check if the signal action is increasing the actal open position
		position_side = position.side
		if (position_side == 'LONG' and signal.action == 'BUY'):
			signal.verified = False
		elif (position_side == 'SHORT' and signal.action == 'SELL'):
			signal.verified = False
		else:
			signal.verified = True
		
		if signal.verified == False:
			self.logger.warning('Order refused. Position increase not allowed.')
